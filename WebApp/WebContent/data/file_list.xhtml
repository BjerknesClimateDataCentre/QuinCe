<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	template="/templates/app_page.xhtml">

	<ui:define name="localHead">
	    <script type="text/javascript">  
	      function deleteFile(id, fileName) {
	    	  if (confirm('Are you sure you want to delete file ' + fileName + '?')) {
	    		  $('#fileListForm\\:chosenFile').val(id);
	    		  return true;
	    	  } else {
	    		  return false;
	    	  }
	      }
	      
	      function reprocessFile(id, fileName) {
	    	  if (confirm('Are you sure you want to reprocess file ' + fileName + '?')) {
	    		  $('#fileListForm\\:chosenFile').val(id);
	    		  return true;
	    	  } else {
	    		  return false;
	    	  }
	      }
	      
	      function dataScreen(id) {
	    	  $('#fileListForm\\:fileId').val(id);
	    	  return true;
	      }
	      
	      function exportFile(id) {
	    	  $('#fileListForm\\:chosenFile').val(id);
	      }
	      
		  function triggerUpdateFileList() {
              $('#fileListForm\\:updateFileList').trigger("click");
		  }
		  
          setInterval(function() {
        	  triggerUpdateFileList();
          }, 10000);
	  	</script>
	</ui:define>

	<ui:define name="content">
	    <div id="qcPopup" class="popup">
	      <table>
	        <tr class="bad">
	          <td>Error</td>
	          <td id="qcBad" class="numericCol"></td>
	        </tr>
	        <tr class="questionable">
	          <td>Warning</td>
	          <td id="qcQuestionable" class="numericCol"></td>
	        </tr>
	        <tr class="good">
	          <td>Passed</td>
	          <td id="qcGood" class="numericCol"></td>
	        </tr>
	        <tr class="ignore">
	          <td>Ignored</td>
	          <td id="qcIgnored" class="numericCol"></td>
	        </tr>
	      </table>
	    </div>
	
	    <div id="wocePopup" class="popup">
	      <table>
	        <tr class="bad">
	          <td>Bad</td>
	          <td id="woceBad" class="numericCol"></td>
	        </tr>
	        <tr class="questionable">
	          <td>Questionable</td>
	          <td id="woceQuestionable" class="numericCol"></td>
	        </tr>
	        <tr class="good">
	          <td>Marked Good</td>
	          <td id="woceGood" class="numericCol"></td>
	        </tr>
	        <tr class="assumedGood">
	          <td>Assumed Good</td>
	          <td id="woceAssumedGood" class="numericCol"></td>
	        </tr>
	        <tr class="needsFlagging">
	          <td>Needs Flagging</td>
	          <td id="woceNeedsFlagging" class="numericCol"></td>
	        </tr>
	        <tr class="ignored">
	          <td>Ignored</td>
	          <td id="woceIgnored" class="numericCol"></td>
	        </tr>
	      </table>
	    </div>
		<h1>Your files</h1>
		<div class="fullPage">
			<h:form id="fileListForm" method="post" accept-charset="utf8">
			    <div id="hiddenData">
					<h:commandLink id="updateFileList" action="#{fileListBean.updateFileList}">		
						<f:ajax render="@form :fileListForm:fileList"/>		
					</h:commandLink>
			    </div>
				
				<h:inputHidden id="chosenFile" value="#{fileListBean.chosenFile}"/>
				<h:inputHidden id="fileId" value="#{dataScreenBean.fileId}"/>
				
				<p:dataTable id="fileList" var="file" value="#{fileListBean.fileList}" scrollable="true" scrollHeight="450">
					<p:column>
						<f:facet name="header">File</f:facet>
						#{file.fileName}
					</p:column>
					<p:column>
						<f:facet name="header">Instrument</f:facet>
						#{file.instrument}
					</p:column>
					<p:column>
						<f:facet name="header">Start Date</f:facet>
						#{file.startDateString}
					</p:column>
					<p:column>
						<f:facet name="header">Ocean/Atmos/Standards</f:facet>
						#{file.recordBreakdown}
					</p:column>
					<p:column>
						<f:facet name="header">Status</f:facet>
						#{file.jobName}
					</p:column>
					<p:column>
						<f:facet name="header">QC Stats</f:facet>
						<h:outputText class="bad" value="#{file.qcBadCount + file.qcFatalCount}"/>
			            <h:outputText class="bad" value="(#{file.qcFatalCount})" rendered="#{file.qcFatalCount > 0}"/>
						/
			            <h:outputText class="questionable" value="#{file.qcQuestionableCount}"/>
						/
			            <h:outputText class="good" value="${file.qcGoodCount}"/>
					</p:column>
					<p:column>
						<f:facet name="header">WOCE Stats</f:facet>
			            <h:outputText class="bad" value="#{file.woceBadCount + file.woceFatalCount}"/>
			            <h:outputText class="bad" value="(#{file.woceFatalCount})" rendered="#{file.woceFatalCount > 0}"/>
			            /
			            <h:outputText class="questionable" value="#{file.woceQuestionableCount}"/>
			            /
			            <h:outputText class="good" value="${file.woceGoodCount + file.woceAssumedGoodCount}"/>
			            /
			            <h:outputText class="needsFlagging" value="#{file.woceNeededCount}"/>
					</p:column>
					<p:column>
						<f:facet name="header">Actions</f:facet>
						<h:commandLink id="QC_#{file.fileId}" onclick="dataScreen(#{file.fileId})" action="#{dataScreenBean.start}" rendered="#{file.qcable}">
							<h:graphicImage value="/resources/image/qc.svg" styleClass="actionIcon" alt="QC" title="QC"/>
						</h:commandLink>
						<h:graphicImage value="/resources/image/qc_disabled.svg" styleClass="actionIcon" alt="QC (disabled)" title="QC (disabled)" rendered="#{!file.qcable}"/>
						<h:commandLink id="Export_#{file.fileId}" onclick="exportFile(#{file.fileId})" action="#{fileListBean.export}" rendered="#{file.exportable}">
							<h:graphicImage value="/resources/image/export.svg" styleClass="actionIcon" alt="Export" title="Export"/>
						</h:commandLink>
						<h:graphicImage value="/resources/image/export_disabled.svg" styleClass="actionIcon" alt="Export (disabled)" title="Export (disabled)" rendered="#{!file.exportable}"/>
						<h:commandLink id="Delete_#{file.fileId}" onclick="deleteFile(#{file.fileId}, '#{file.fileName}')" action="#{fileListBean.deleteFile}" rendered="#{file.deleteable}">
							<h:graphicImage value="/resources/image/delete.svg" styleClass="actionIcon" alt="Delete" title="Delete"/>
						</h:commandLink>
						<h:graphicImage value="/resources/image/delete_disabled.svg" styleClass="actionIcon" alt="Reprocess (disabled)" title="Reprocess (disabled)" rendered="#{!file.deleteable}"/>
						<h:commandLink id="Reprocess_#{file.fileId}" onclick="reprocessFile(#{file.fileId}, '#{file.fileName}')" action="#{fileListBean.reprocessFile}" rendered="#{file.recalculateable}">
							<h:graphicImage value="/resources/image/recalculate.svg" styleClass="actionIcon" alt="Reprocess" title="Reprocess"/>
						</h:commandLink>
						<h:graphicImage value="/resources/image/recalculate_disabled.svg" styleClass="actionIcon" alt="Reprocess (disabled)" title="Reprocess (disabled)" rendered="#{!file.recalculateable}"/>
					</p:column>
				</p:dataTable>
				
				<div class="buttonWrapper">
					<h:commandButton value="Upload" action="#{fileListBean.uploadFile}"/>
				</div>
				
			</h:form>
		</div>
	</ui:define>
</ui:composition>
