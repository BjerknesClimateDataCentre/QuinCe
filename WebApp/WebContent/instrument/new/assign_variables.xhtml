<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	template="/WEB-INF/templates/new_instrument.xhtml">

	<ui:define name="title">New Instrument</ui:define>
	<ui:define name="instrumentHead">
		<c:set var="instrumentStep" value="1" scope="request"/>	
		<h:outputScript name="script/datatables.min.js"/>
		<h:outputStylesheet name="style/datatables.min.css"/>
		<script>
			$(document).ready(function() {
				renderAssignments();
				
				$('body').click(function () {
					hideAssignmentMenu();
				});
			});
			
			// Global!
			tabCount = 0;
			
			// The data tables in each tab
			var tabTables = new Array();
			
			var filesAndColumns = #{newInstrumentBean.filesAndColumns};
		</script>	
	</ui:define>
	<ui:define name="new_instrument_content">
		<div id="assignmentMenu" class="ui-menu ui-widget ui-widget-content ui-corner-all ui-helper-clearfix ui-shadow ui-overlay-hidden" role="menu"></div>
	
		<h:form id="newInstrumentForm" metho="post" charset="utf8">
		
			<h:inputHidden id="sensorAssignments" value="#{newInstrumentBean.sensorAssignments}" size="100"/>
			<h:inputHidden id="timePositionAssignments" value="#{newInstrumentBean.timePositionAssignments}"/>
			
			<p:dialog header="Assign Column To Sensor" widgetVar="sensorAssignmentDialog" modal="true">
				<h:inputHidden id="sensorAssignmentFile" value="#{newInstrumentBean.sensorAssignmentFile}"/>
				<h:inputHidden id="sensorAssignmentColumn" value="#{newInstrumentBean.sensorAssignmentColumn}"/>
				<h:inputHidden id="sensorAssignmentSensorType" value="#{newInstrumentBean.sensorAssignmentSensorType}"/>
				
				<div class="dialogSection">
					<table>
						<tr>
							<td><p:outputLabel value="Assigning"/></td>
							<td><div id="sensorAssignmentFileName" class="variableText"></div>, <div id="sensorAssignmentColumnName" class="variableText"></div></td>
						</tr>
						<tr>
							<td><p:outputLabel value="To sensor"/></td>
							<td><div id="sensorAssignmentSensorTypeText" class="variableText"></div></td>
						</tr>
					</table>
				</div>
				<div id="sensorAssignmentPrimaryContainer" class="dialogSection">
					<div>
						<p:outputLabel value="Is this a primary or fallback sensor?"/> <i>??</i>
					</div>
					<div>
						<p:selectOneRadio id="sensorAssignmentPrimary" widgetVar="primary" value="#{newInstrumentBean.sensorAssignmentPrimary}">
							<f:selectItem itemLabel="Primary" itemValue="true"/>
							<f:selectItem itemLabel="Fallback" itemValue="false"/>
						</p:selectOneRadio>
					</div>
				</div>
				<div id="sensorAssignmentPostCalibration" class="dialogSection">
					<div>
						<p:outputLabel value="Should calibration adjustments be applied to this sensor?"/> <i>??</i>
					</div>
					<div>
						<p:selectOneRadio id="sensorAssignmentPostCalibrated" value="#{newInstrumentBean.sensorAssignmentPostCalibrated}">
							<f:selectItem itemLabel="Yes" itemValue="true"/>
							<f:selectItem itemLabel="No" itemValue="false"/>
						</p:selectOneRadio>
					</div>
				</div>
				<div id="sensorAssignmentDependsQuestionContainer" class="dialogSection">
					<label id="sensorAssignmentDependsQuestion" class="ui-outputlabel ui-widget"></label>
					<div>
						<p:selectOneRadio id="sensorAssignmentDependsQuestionAnswer" value="#{newInstrumentBean.sensorAssignmentDependsQuestionAnswer}">
							<f:selectItem itemLabel="Yes" itemValue="true"/>
							<f:selectItem itemLabel="No" itemValue="false"/>
						</p:selectOneRadio>
					</div>
				</div>
				
				<h:panelGrid columns="2" cellpadding="5" styleClass="buttonPanel">
					<p:commandButton value="Assign" ajax="true" action="#{newInstrumentBean.storeSensorAssignment}"
					  process="sensorAssignmentFile sensorAssignmentColumn sensorAssignmentSensorType sensorAssignmentPrimary sensorAssignmentPostCalibrated sensorAssignmentDependsQuestionAnswer"
					  update="sensorAssignmentFile sensorAssignmentColumn sensorAssignmentSensorType sensorAssignmentPrimary sensorAssignmentPostCalibrated sensorAssignmentDependsQuestionAnswer sensorAssignments"
					  oncomplete="sensorAssigned();"/>
					<p:commandButton value="Cancel" ajax="true" action="#{newInstrumentBean.resetSensorAssignmentValues}" process="@none"
					  update="sensorAssignmentFile sensorAssignmentColumn sensorAssignmentSensorType sensorAssignmentPrimary sensorAssignmentPostCalibrated sensorAssignmentDependsQuestionAnswer" oncomplete="PF('sensorAssignmentDialog').hide();"/>
				</h:panelGrid>
				
			</p:dialog>
			<p:dialog header="Assign Longitude" widgetVar="longitudeAssignmentDialog" modal="true">
				<h:inputHidden id="longitudeFile" value="#{newInstrumentBean.longitudeFile}"/>
				<h:inputHidden id="longitudeColumn" value="#{newInstrumentBean.longitudeColumn}"/>
			
				<table>
					<tr>
						<td><p:outputLabel value="Assigning"/></td>
						<td><div id="longitudeAssignmentFile" class="variableText"></div>, <div id="longitudeAssignmentColumn" class="variableText"></div></td>
					</tr>
					<tr>
						<td><p:outputLabel value="To sensor"/></td>
						<td><div class="variableText">Longitude</div></td>
					</tr>
				</table>
				<div class="dialogSection">
					<table>
						<tr>
							<td><p:outputLabel value="Format:"/></td>
							<td>
								<p:selectOneMenu id="longitudeFormat" value="#{newInstrumentBean.longitudeFormat}">
									<f:selectItem itemLabel="0° to 360°" itemValue="0"/>
									<f:selectItem itemLabel="-180° to 180°" itemValue="1"/>
									<f:selectItem itemLabel="0° to 180° (hemisphere specified separately)" itemValue="2"/>
								</p:selectOneMenu>
							</td>
						</tr>
					</table>
				</div>
				<h:panelGrid columns="2" cellpadding="5" styleClass="buttonPanel">
					<p:commandButton value="Assign" ajax="true" action="#{newInstrumentBean.assignLongitude}"
					  process="longitudeFile longitudeColumn longitudeFormat"
					  update="timePositionAssignments"
					  oncomplete="timePositionAssigned('longitudeAssignmentDialog');"/>
					<p:commandButton value="Cancel" onclick="PF('longitudeAssignmentDialog').hide(); return false;"/>
				</h:panelGrid>
			</p:dialog>
			
			<p:dialog header="Assign Latitude" widgetVar="latitudeAssignmentDialog" modal="true">
				<h:inputHidden id="latitudeFile" value="#{newInstrumentBean.latitudeFile}"/>
				<h:inputHidden id="latitudeColumn" value="#{newInstrumentBean.latitudeColumn}"/>
			
				<table>
					<tr>
						<td><p:outputLabel value="Assigning"/></td>
						<td><div id="latitudeAssignmentFile" class="variableText"></div>, <div id="latitudeAssignmentColumn" class="variableText"></div></td>
					</tr>
					<tr>
						<td><p:outputLabel value="To sensor"/></td>
						<td><div class="variableText">Latitude</div></td>
					</tr>
				</table>
				<div class="dialogSection">
					<table>
						<tr>
							<td><p:outputLabel value="Format:"/></td>
							<td>
								<p:selectOneMenu id="latitudeFormat" value="#{newInstrumentBean.latitudeFormat}">
									<f:selectItem itemLabel="-90° to 90°" itemValue="0"/>
									<f:selectItem itemLabel="0° to 90° (hemisphere specified separately)" itemValue="1"/>
								</p:selectOneMenu>
							</td>
						</tr>
					</table>
				</div>
				<h:panelGrid columns="2" cellpadding="5" styleClass="buttonPanel">
					<p:commandButton value="Assign" ajax="true" action="#{newInstrumentBean.assignLatitude}"
					  process="latitudeFile latitudeColumn latitudeFormat"
					  update="timePositionAssignments"
					  oncomplete="timePositionAssigned('latitudeAssignmentDialog');"/>
					<p:commandButton value="Cancel" onclick="PF('latitudeAssignmentDialog').hide(); return false;"/>
				</h:panelGrid>
			</p:dialog>

			<p:fieldset id="assignmentsPanel" legend="Column Assignments" style="margin-bottom: 20px">
				<div id="assignmentsList"></div>
			</p:fieldset>
			
			<p:tabView value="#{newInstrumentBean.instrumentFiles}" var="iFile" widgetVar="fileTabs">
				<p:tab title="#{iFile.fileDescription}">
					<div class="fileTab">
						<div class="fileAssignments">
							<p:fieldset legend="Date/Time" toggleable="true" style="margin-bottom: 20px;">
								<script>
									document.write('<div id="dateTimeColumns-' + tabCount + '"></div>');
								</script>
						    </p:fieldset>
							<p:fieldset legend="Position" toggleable="true">
								<script>
									document.write('<div id="positionColumns-' + tabCount + '"></div>');
								</script>
						    </p:fieldset>
						</div>
						
						<script>
							var containerId = 'fileTableContainer-' + tabCount;
							var tableId = 'fileTable-' + tabCount;
							
							document.write('<div id="' + containerId + '" class="sampleDataTableContainer"></div>');
						
							var html = '';
							
							html += '<table id="' + tableId + '" class="sampleData compact nowrap cell-border stripe">';
							html += '<thead>';
							
							var headers = JSON.parse('#{iFile.fileColumns}');
							for (var i = 0; i &lt; headers.length; i++) {
								html += '<th class="ui-state-default assignmentCol" onclick="showAssignmentMenu(event, ' + tabCount + ', ' + i + ')">';
								html += $('<div/>').text(headers[i]).html(); // Funky HTML escaping
								html += '</th>';
							}
							
							html += '</thead><tbody>';
	
							var data = JSON.parse('#{iFile.jsonData}');
							for (var i = 0; i &lt; data.length; i++) {
								var row = data[i];
								
								html += '<tr>';
								for (var j = 0; j &lt; row.length; j++) {
									html += '<td>';
									html += $('<div/>').text(row[j]).html(); // Funky HTML escaping
									html += '</td>';
								} 
								html += '</tr>';
							}
	
							html += '</tbody></table>';
							
							$('#' + containerId).html(html);
							tabTables.push($('#' + tableId).DataTable({
						    	ordering: false,
						    	searching: false,
						    	scrollY: '400px',
								scrollX: true,
								paging: false,
								info: false
							}));
							
							tabCount++;
						</script>
					</div>
				</p:tab>
			</p:tabView>
		
			<h:panelGrid columns="1" cellpadding="5" styleClass="buttonPanel">
				<p:commandButton value="Add File" ajax="false" action="#{newInstrumentBean.addFile}" immediate="true"/>
			</h:panelGrid>

			<!--  The cancel include has a 2 entries (1 is invisible) -->
			<h:panelGrid columns="4" cellpadding="5" styleClass="buttonPanel">
				<ui:include src="/WEB-INF/templates/new_instrument_cancel.xhtml"/>
				<p:commandButton value="Back" ajax="false" action="#{newInstrumentBean.goToName}" immediate="true"/>
				<p:commandButton id="nextButton" widgetVar="next" value="Next" ajax="false" action="#{newInstrumentBean.goToFiles}"/>
			</h:panelGrid>
		</h:form>
	</ui:define>
</ui:composition>
