# _QuinCe Project Specification_

# Introduction
The QuinCe project is a software system to designed to streamline the processing and quality control of data from continuous CO~2~ measurement instruments on board ships. The system will be developed as part of the Marine portion of the EU Integrated Carbon Observing System ([ICOS](http://www.icos-infrastructure.eu/)).

The project is initially intended for use by scientists taking part in the Marine portion of the ICOS project, and will focus primarily on their requirements and those of ICOS itself. However, the long term aim is to provide its services to the global surface ocean CO~2~ community in the future, and perhaps provide an example to develop similar systems for automated data collection efforts in other fields.

# Project Features
The aim of the QuinCe project is to provide an online, automated system that will process raw data from ship-board CO~2~ measuring equipment. The processing will consist of the following:

* Data reduction
* Automatic Level One quality control
* Data viewing
* Assignment of WOCE QC flags
* Data export
* Submission to the ICOS [Carbon Portal](https://www.icos-cp.eu/).

## Data Reduction
Data reduction is the process of converting calculating the partial pressure and/or fugacity of carbon dioxide (pCO~2~ or fCO~2~) from the raw instrument data. These calculations must take into account the calibration of individual sensors and also adjust the results in relation to the instruments' measurements taken from known gas standards.

Data reduction is currently performed by the scientists running their own instruments. While all scientists will perform their calculations based on practices described in the scientific literature, there will inevitably be slight differences between them through the use of different methods and different interpretations of those methods. This document will specify the data reduction method to be used by the QuinCe system, as agreed in discussion with the scientific community.

## Automatic Level One Quality Control
Once the data reduction has been completed, a set of automatic quality control routines will examine the data, looking for anomalies that indicate likely problems. These will include, but not be limited to:

* Missing data
* Values outside a reasonable ranges
* Detection of outliers
* Excessive variability in the data

The quality control routines will be written as individual modules, so more can be added as they are developed. This document will specify the framework for the modular system, but not the workings of any individual quality control modules. Those will be described in separate documentation.

## Data Viewing
The QuinCe system will allow users to view the contents of their data files on maps, plots, and in tabular form. Results from the data reduction and quality control stages will also be visible, allowing the user to examine them within the system.

## Assignment of WOCE QC Flags
The user will be able to assign WOCE QC flags and sub-flags (which indicate the item(s) that led to the assignment of the main flag) to the individual records in a data file. These flags can be used to remove bad records from the data or to indicate the quality of the data to future users after publication.

## Data Export
The QuinCe system will add extra information to the uploaded data files as it performs data reduction and quality control, along with the WOCE flags set by the user. The system will allow the user to export their data, along with these additions, in a variety of formats. The most basic export options will be:

* The original data file, with extra columns added.
* A cut-down version of the file, containing only the original data used in the data reduction steps and extra columns added.

In addition, the system will allow users to export data in a variety of formats for submissions to other systems, e.g. [SOCAT](http://www.socat.info).

## Submission to the ICOS Carbon Portal
All data collected under the umbrella of the ICOS project will need to be published through the [ICOS Carbon Portal](https://www.icos-cp.eu/). The QuinCe system will provide a method for users to submit data to this portal directly, reformatting the data as required.

# Defining Instrument Details

## Naming Instruments
QuinCe will identify each instrument that it knows about by a single string that contains a name, which must be unique across all known instruments. Typically this will contain the name of the ship on which the instrument is installed. However, it is possible that more than one instrument may be installed on the same ship, or multiple ships have the same name. In this case, further identifying features (e.g. instrument name or ship call sign) will be required. The choice of instrument name will be left to the individual user.

## Instrument Parameters
Each instrument must provide a minimum set of measured parameters. These are in three broad categories.

### Location and Time
Each measurement must be located in space and time, and these values must be part of the instrument's output. Positional data must be provided as latitude and longitude, usually as decimal degrees, although other formats (e.g. degrees and decimal minutes, or degrees, minutes and seconds) can be supported. The date and time of the measurement must be provided to an accuracy of one second. Again, multiple formats of dates will be supported.

### Measurement types

In many cases, not all measurements reported in the data files are of sea water CO~2~. It is usual practice to intersperse periods of surface CO~2~ measurements with measurements from a set of gas standards, to allow for calibration of the instrumentation [e.g. _Pierrot et al. 2009_]. QuinCe must be able to identify which records from data files correspond to sea water measurements, and which to gas standards of different concentrations. This will allow the system to automatically calibrate the sea water measurements against the gas standards, and also to process the gas standard measurements separately from the sea water measurements during quality control.

There are periods when measurements from an instrument cannot be trusted. For example, when switching between sea water measurements and gas standard measurements, there is usually a period of flushing to ensure that the gas lines do not contain residual gases from a previous set of measurements [_Pierrot et al. 2009_]. During this time, it is likely that measurements are still being recorded by the instrument. If possible, these measurements should be marked as unusable: otherwise the variability in CO~2~ values during these periods may cause quality control issues to be raised unnecessarily.

### Sensor Parameters
QuinCe will require data from sensors measuring the following parameters in order to perform the data reduction calculations:

* Sea surface temperature
* Sea level pressure
* Sea surface salinity
* Equilibrator temperature
* Equilibrator pressure

QuinCe will require at least one sensor from each category to be defined, although any number of sensors can be present for each category. For example, in large equilibrators, two temperature sensors are sometimes installed to measure the top and bottom. Where more than one sensor of a given type is present, the mean of all measured values will be used in calculations performed by QuinCe. This will be described in detail later in the document.

For each sensor, the user must specify the units in which its output is recorded in the data files. For example, some temperature sensors report degrees Celsius directly, while some resistive temperature sensors report their measurements in ohms. In the latter case there is a polynomial equation that is used to convert the reported resistance to Celsius. In these cases, the user must enter the parameters of that equation so that QuinCe can convert the data.

## Data file specification
Each instrument will produce a data file whose format is likely to be unique. The user must therefore tell QuinCe which columns contain which data. The user need only specify the columns required for data reduction (i.e. the required sensors), the ship's position, and the time of the measurement. Any other columns in the data files will be ignored.

One of the columns in the data file must specify the type of each measurement: either sea water or a gas standard. The user must specify which column contains this information, and which values indicate sea water measurements or gas standard measurements of specific concentrations.

If there is a column in the data file that indicates whether or not a given measurement should be ignored, then this must also be specified, along with which value(s) indicate measurements to be used and those to be discarded.

# Uploading data files
Once an instrument and its corresponding data format have been defined, the user will be able to upload data files for analysis. Each file will be uniquely identified by its filename and the name of the instrument from which it was produced. If a file of the same name already exists, the user will be asked to choose what to do with it:

* Replace the existing file of the same name and restart analysis from the beginning (all previous analysis will be lost).
* Give the file a different name and treat it as a brand new file.
* Abort the attempt to upload the file.

Once the file has been uploaded, it will be put through the data reduction and quality control routines as described below.

## Removal of data files
QuinCe will not keep copies of uploaded data files indefinitely; they will only exist on the system for as long as they are being analysed. Users will be encouraged to delete their files once the analysis is complete and they have exported all the results they need. If a file is left untouched for 60 days, the file and any related analysis will be automatically deleted. The user will be given appropriate warnings before this happens.

# References
Pierrot, D., C. Neill, K. Sullivan, R. Castle, R. Wanninkhof, H. Lüger, T. Johannessen, A. Olsen, R. A. Feely, and C. E. Cosca, 2009. Recommendations for autonomous underway pCO~2~ measuring systems and data-reduction routines, _Deep Sea Research II_, _56_, 512-522, doi:10.1016/j.dsr2.2008.12.005.
